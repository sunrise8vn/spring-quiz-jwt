<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>[Quiz] Spring Controller: Attempt review</title>

    <!-- bootstrap css -->
    <link rel="stylesheet" type="text/css" href="/assets/bootstrap/css/bootstrap.css">

    <!-- Font awesome 6 -->
    <link rel="stylesheet" type="text/css" href="/assets/font-awesome-6.1.1/css/all.css">

    <!-- custom styles -->
    <link rel="stylesheet" type="text/css" href="/assets/quiz/css/style-history.css">
    <link rel="stylesheet" type="text/css" href="/assets/quiz/css/responsive.css">
    <link rel="stylesheet" type="text/css" href="/assets/quiz/css/animation.css">

    <style>
        .lg-panel-right {
            display: flex;
            flex-direction: column;
            margin: 50px 0;
            padding-left: 25px;
            gap: 15px;
        }
        .btn-question {
            border-radius: 46px;
            width: 270px;
            z-index: 10000;
            padding: 10px 15px;
        }
        .btn-question .btn {
            margin-bottom: 5px;
        }
        .btn-finish {
            border-radius: 46px;
            width: 270px;
            z-index: 10000;
            padding: 10px 15px;
        }
    </style>

</head>
<body class="show-section">

    <section class="steps" id="step">
        <div class="container">
            <div class="mx-auto col-md-10 col-lg-10" style="float: left;">

                <form id="steps" class="show-section" method="post">
                    <!-- step-1 -->
                    <section class="steps-inner pop-slide" id="step-1">
                        <div class="wrapper">
                            <div class="step-heading">
                                <h2>Quiz</h2>
                                <!--                                <p>Fill out this Trivia quiz for fun!</p>-->
                            </div>
                            <div class="step-bar">
                                        <span class="step-counter">
                                            Question 1 / 4
                                        </span>
                                <div class="step-bar-inner">
                                    <div class="step-bar-move step-move m25"></div>
                                </div>
                            </div>
                            <div>
                                <div class="form-heading">
                                    Make a Multiple Choice Test Template Using Excel
                                </div>
                                <div class="form-inner">
                                    <label class="form-input">
                                        <input type="radio" name="work" value="Activate Developer Tab">
                                        Activate Developer Tab
                                    </label>
                                    <label class="form-input">
                                        <input type="radio" name="work" value="Providing a Lecturer">
                                        Providing a Lecturer
                                    </label>
                                    <label class="form-input">
                                        <input type="radio" name="work" value="Personally Quizzes">
                                        Personally Quizzes
                                    </label>
                                    <label class="form-input">
                                        <input type="radio" name="work" value="Massive Batches" checked>
                                        Massive Batches
                                    </label>
                                </div>

                                <!-- next-prev-btn -->
                                <div class="form-buttons">
                                    <button type="button" class="next">next question<i class="fa-solid fa-arrow-right"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- step-2 -->
                    <section class="steps-inner" id="step-2">
                        <div class="wrapper">
                            <div class="step-heading">
                                <h2>Quiz</h2>
                                <!--                                <p>Fill out this Trivia quiz for fun!</p>-->
                            </div>
                            <div class="step-bar">
                                        <span class="step-counter">
                                            Question 2 / 4
                                        </span>
                                <div class="step-bar-inner">
                                    <div class="step-bar-move step-move m50"></div>
                                </div>
                            </div>
                            <div>
                                <div class="form-heading">
                                    Select What Suits you Best and Help us Improve Our Services.
                                </div>
                                <div class="form-inner pop-slide">
                                    <label class="form-input">
                                        <input type="radio" name="work1" value="Fronted Developer">
                                        Fronted Developer
                                    </label>
                                    <label class="form-input">
                                        <input type="radio" name="work1" value="Web Designer">
                                        Web Designer
                                    </label>
                                    <label class="form-input">
                                        <input type="radio" name="work1" value="Full Stack Developer">
                                        Full Stack Developer
                                    </label>
                                    <label class="form-input">
                                        <input type="radio" name="work1" value="Backend Developer" checked>
                                        Backend Developer
                                    </label>
                                </div>

                                <!-- next-prev-btn -->
                                <div class="form-buttons">
                                    <button type="button" class="prev"><i class="fa-solid fa-arrow-left"></i>last question
                                    </button>
                                    <button type="button" class="next">next question<i class="fa-solid fa-arrow-right"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- step-3 -->
                    <section class="steps-inner" id="step-3">
                        <div class="wrapper">
                            <div class="step-heading">
                                <h2>Quiz</h2>
                                <!--                                <p>Fill out this Trivia quiz for fun!</p>-->
                            </div>
                            <div class="step-bar">
                                        <span class="step-counter">
                                            Question 3 / 4
                                        </span>
                                <div class="step-bar-inner">
                                    <div class="step-bar-move step-move m75"></div>
                                </div>
                            </div>
                            <div>
                                <div class="form-heading">
                                    Make a Multiple Choice Test Template Using Excel
                                </div>
                                <div class="form-inner pop-slide">
                                    <label class="form-input">
                                        <input type="radio" name="work3" value="Activate Developer Tab">
                                        Activate Developer Tab
                                    </label>
                                    <label class="form-input">
                                        <input type="radio" name="work3" value="Providing a Lecturer">
                                        Providing a Lecturer
                                    </label>
                                    <label class="form-input">
                                        <input type="radio" name="work3" value="Personally Quizzes">
                                        Personally Quizzes
                                    </label>
                                    <label class="form-input">
                                        <input type="radio" name="work3" value="Massive Batches" checked>
                                        Massive Batches
                                    </label>
                                </div>

                                <!-- next-prev-btn -->
                                <div class="form-buttons">
                                    <button type="button" class="prev"><i class="fa-solid fa-arrow-left"></i>last question
                                    </button>
                                    <button type="button" class="next">next question<i class="fa-solid fa-arrow-right"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- step-4 -->
                    <section class="steps-inner" id="step-4">
                        <div class="wrapper">
                            <div class="step-heading">
                                <h2>Quiz</h2>
                                <!--                                <p>Fill out this Trivia quiz for fun!</p>-->
                            </div>
                            <div class="step-bar">
                                        <span class="step-counter">
                                            Question 4 / 4
                                        </span>
                                <div class="step-bar-inner">
                                    <div class="step-bar-move step-move m100"></div>
                                </div>
                            </div>
                            <div>
                                <div class="form-heading">
                                    Select What Suits you Best and Help us Improve Our Services.
                                </div>
                                <div class="form-inner pop-slide">
                                    <label class="form-input">
                                        <input type="radio" name="work4" value="Fronted Developer">
                                        Fronted Developer
                                    </label>
                                    <label class="form-input">
                                        <input type="radio" name="work4" value="Web Designer">
                                        Web Designer
                                    </label>
                                    <label class="form-input">
                                        <input type="radio" name="work4" value="ull Stack Developer">
                                        Full Stack Developer
                                    </label>
                                    <label class="form-input">
                                        <input type="radio" name="work4" value="Backend Developer" checked>
                                        Backend Developer
                                    </label>
                                </div>

                                <!-- next-prev-btn -->
                                <div class="form-buttons">
                                    <button type="button" class="prev"><i class="fa-solid fa-arrow-left"></i>last question
                                    </button>
                                    <button id="sub" type="button" class="apply">submit<i
                                            class="phone-ring fa-solid fa-thumbs-up"></i></button>
                                </div>
                            </div>
                        </div>
                    </section>
                </form>
            </div>

            <div class="mx-auto col-md-2 col-lg-2 lg-panel-right" style="float: left;">
                <!-- timer -->
                <div class="sm-stickys">
                    <div class="timer">
                        <div class="countdown">
                            <span id="countdown-timer" class="time">60</span>
                            <span class="time-ex">sec</span>
                        </div>
                        <div class="timer-heading">
                            Quiz<br/>
                            Time start
                        </div>
                    </div>
                </div>

                <div class="sm-stickys">
                    <div class="btn-question">
                        <!--                        <button class="btn btn-outline-primary">-->
                        <!--                            1-->
                        <!--                        </button>-->
                        <!--                        <button class="btn btn-outline-primary">-->
                        <!--                            2-->
                        <!--                        </button>-->
                        <!--                        <button class="btn btn-outline-primary">-->
                        <!--                            1-->
                        <!--                        </button>-->
                        <!--                        <button class="btn btn-outline-primary">-->
                        <!--                            2-->
                        <!--                        </button>-->
                        <!--                        <button class="btn btn-outline-primary">-->
                        <!--                            1-->
                        <!--                        </button>-->
                        <!--                        <button class="btn btn-outline-primary">-->
                        <!--                            2-->
                        <!--                        </button>-->
                        <!--                        <button class="btn btn-outline-primary">-->
                        <!--                            1-->
                        <!--                        </button>-->
                        <!--                        <button class="btn btn-outline-primary">-->
                        <!--                            2-->
                        <!--                        </button>-->
                    </div>
                </div>

                <div class="sm-stickys">
                    <div class="btn-finish">
                        <button id="btnFinish" class="btn btn-outline-success">
                            Nộp bài
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </section>


    <div id="error"></div>

    <!-- bootstrap JS -->
    <script src="/assets/bootstrap/js/bootstrap.bundle.min.js"></script>

    <!-- Jquery -->
    <script src="/assets/jquery/jquery-3.6.0.min.js"></script>

    <!-- custom JS -->
    <script src="/assets/quiz/js/custom.js"></script>

    <script src="/assets/js/app.js"></script>

    <script>

        const page = {
            url: {
                getQuiz: AppBase.BASE_URL_STUDENT + '/quiz',
                answer: AppBase.BASE_URL_STUDENT + '/quiz',
                finish: AppBase.BASE_URL_STUDENT + '/quiz/finish'
            },
            elements: {},
            loadData: {},
            commands: {}
        }

        const quizExamId = [[${quizExamId}]]
        const offsetIndex = [[${page}]]
        let quizQuestionId = 0;
        let numberQuestion = 0;
        let questionType;

        page.elements.steps = $('#steps');
        page.elements.btnQuestion = $('.btn-question');
        page.elements.btnFinish = $('#btnFinish');

        page.commands.getQuiz = () => {
            $.ajax({
                type: 'GET',
                url: page.url.getQuiz + '/' + quizExamId + '/' + offsetIndex
            })
                .done((data) => {
                    quizQuestionId = data.quizQuestionId;
                    numberQuestion = data.numberQuestion;
                    questionType = data.questionType;
                    const questionAnswered = data.questionAnswered;

                    page.elements.steps.empty();
                    page.elements.btnQuestion.empty();

                    const str = page.commands.renderQuiz(data, 1);
                    page.elements.steps.append(str);

                    $.each(questionAnswered, (index, item) => {
                        const numberQuestionStr = page.commands.renderNumberQuestion(index, item);
                        page.elements.btnQuestion.append(numberQuestionStr);
                    })
                })
                .fail((jqXHR) => {
                    console.log(jqXHR)
                })
        }

        page.commands.renderAnswers = (id, title, checked, questionType) => {
            const questionTypeStr = questionType === 'MULTIPLE' ?  'checkbox' : 'radio'
            return `
                    <label class="form-input">
                        <input type="${questionTypeStr}" name="ip-answer" value="${id}" class="ip-answer" ${checked === true ? 'checked' : ''}>
                        ${title}
                    </label>
                `;
        }

        page.commands.getQuizByQuestion = (num) => {
            page.commands.handleChangeUrl(num);

            $.ajax({
                type: 'GET',
                url: page.url.getQuiz + '/' + quizExamId + '/' + num
            })
                .done((data) => {
                    quizQuestionId = data.quizQuestionId
                    numberQuestion = data.numberQuestion;
                    questionType = data.questionType;
                    const questionAnswered = data.questionAnswered;

                    page.elements.steps.empty();
                    page.elements.btnQuestion.empty();

                    const str = page.commands.renderQuiz(data, num);
                    page.elements.steps.append(str);

                    $.each(questionAnswered, (index, item) => {
                        const numberQuestionStr = page.commands.renderNumberQuestion(index, item);
                        page.elements.btnQuestion.append(numberQuestionStr);
                    })
                })
                .fail((jqXHR) => {
                    console.log(jqXHR)
                })
        }

        page.commands.renderQuiz = (obj, num) => {
            const choices = (obj.questionType === 'SINGLE' || obj.questionType === 'TRUE_FALSE')
                ? 'Chọn một:'
                : 'Chọn một hoặc nhiều:';

            let answers = ''
            $.each(obj.answers, (index, item) => {
                answers += page.commands.renderAnswers(item.id, item.content, item.checked, obj.questionType);
            })

            const nextPage = num + 1;
            const lastPage = num - 1;

            let nextButton = `
                    <button type="button" class="next" data-exam-id="${obj.quizExamId}" data-num-page="${nextPage}">
                        next question
                        <i class="fa-solid fa-arrow-right"></i>
                    </button>
                `;

            let lastButton = `
                    <button type="button" class="prev" data-exam-id="${obj.quizExamId}" data-num-page="${lastPage}">
                        <i class="fa-solid fa-arrow-left"></i>
                        last question
                    </button>
                `;

            return `
                    <section class="steps-inner pop-slide" id="step-1">
                        <div class="wrapper">
                            <div class="step-heading">
                                <h2>${obj.quizExamTitle}</h2>
                            </div>
                            <div class="step-bar">
                                    <span class="step-counter">
                                        Question ${num} / ${obj.numberQuestion}
                                    </span>
                                <div class="step-bar-inner">
                                    <div class="step-bar-move step-move m25"></div>
                                </div>
                            </div>
                            <div>
                                <div class="form-heading-question-title">
                                    ${obj.questionContent}
                                </div>
                                <div class="form-heading">
                                    ${choices}
                                </div>
                                <div class="form-inner">
                                    ${answers}
                                </div>

                                <!-- next-prev-btn -->
                                <div class="form-buttons">
                                    ${num === 1 ? nextButton : num === numberQuestion ? lastButton : lastButton + nextButton}
                                </div>
                            </div>
                        </div>
                    </section>
                `;
        }

        page.commands.renderNumberQuestion = (index, obj) => {
            const checked = obj.checked === true ? 'btn-primary' : 'btn-outline-primary';
            return `
                    <button class="btn ${checked} btn-num-question" data-num="${++index}">
                        ${index}
                    </button>
                 `;
        }

        page.commands.handleAnswer = () => {
            const answers = []
            const ipAnswers = $('.ip-answer')

            $.each(ipAnswers, (index, item) => {
                const answer = {
                    id: item.value,
                    ans: item.checked
                }
                answers.push(answer);
            })

            const obj = {
                answers: answers
            }

            $.ajax({
                headers: {
                    'accept': 'application/json',
                    'content-type': 'application/json'
                },
                type: 'POST',
                url: page.url.answer + '/' + quizExamId + '/' + quizQuestionId,
                data: JSON.stringify(obj)
            })
                .done((data) => {

                })
                .fail((jqXHR) => {
                    console.log(jqXHR)
                })
        }

        page.commands.handleFinish = () => {
            $.ajax({
                headers: {
                    'accept': 'application/json',
                    'content-type': 'application/json'
                },
                type: 'POST',
                url: page.url.finish + '?exam-id=' + quizExamId
            })
                .done((data) => {
                    alert('OK')
                })
                .fail((jqXHR) => {
                    console.log(jqXHR)
                })
        }

        page.commands.handleChangeUrl = (num) => {
            const origin = window.location.origin;
            const pathname = window.location.pathname;
            const pageUrl = origin + pathname + '?id=' + quizExamId + '&page=' + num;
            AppBase.modifyUrl('Quiz Form', pageUrl);
        }

        page.initializeControlEvent = () => {
            page.elements.btnQuestion.on('click', '.btn-num-question', function () {
                const num = $(this).data('num');
                page.commands.getQuizByQuestion(num);
            })

            page.elements.steps.on('click', 'button.next', function () {
                const numPage = $(this).data('num-page');

                page.commands.getQuizByQuestion(numPage);
            })

            page.elements.steps.on('click', 'button.prev', function () {
                const numPage = $(this).data('num-page');

                page.commands.getQuizByQuestion(numPage);
            })

            page.elements.steps.on('click', '.ip-answer', () => {
                page.commands.handleAnswer();
            })

            page.elements.btnFinish.on('click', () => {
                page.commands.handleFinish();
            })
        }

        page.loadData = () => {
            page.commands.getQuiz();
        }

        $(() => {
            page.loadData();
            page.initializeControlEvent();
        })


    </script>

</body>

</html>